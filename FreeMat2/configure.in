dnl Process this file with autoconf to produce a configure script.
AC_INIT(src/x11/main.cpp)

dnl sets build, host, target variables and the same with _alias
AC_CANONICAL_SYSTEM

AM_INIT_AUTOMAKE(FreeMat, 1.03)

dnl Checks for programs.
AC_PROG_CXX
AC_PROG_CC
AC_PROG_F77
AM_PROG_LEX
AC_PROG_YACC
AC_PROG_RANLIB

case $host in
*-*-linux-* | *-*-cygwin*)
  FLIBS=`echo $FLIBS | sed -e 's/-lfrtbegin//g'` ;;
esac

case $host in
*-*-darwin*)
  LDFLAGS="$LDFLAGS -L/sw/lib";
  CXXFLAGS="$CXXFLAGS -I/sw/include";
  FLIBS="-lg2c";;
esac

AC_PATH_XTRA

AC_ARG_WITH(debug,
	[AC_HELP_STRING([--with-debug],
		[Include debug options [default=no]])],
		debug_flag="-O0 -g3",
		debug_flag="-O3")

AC_ARG_WITH(miniblas,
	[AC_HELP_STRING([--with-miniblas],
		[Force use of built-in BLAS library [default=no]])],
		forceminiblas="yes",
		forceminiblas="no")

dnl AC_ARG_WITH(mpi,
dnl	[AC_HELP_STRING([--with-mpi],
dnl	        [Build the MPI executables [default=no]])],
dnl		usempi="yes",
dnl		usempi="no")

MP_WITH_CURSES([],[])

case $host in
*-*-cygwin*)
  CURSES_LIB=""
esac

LIBS="$debug_flag $prof_flag $LIBS"
CXXFLAGS="$CXXFLAGS $debug_flag $prof_flag"
YFLAGS="$YFLAGS -d"
LFLAGS="$LFLAGS"

AC_SUBST(YFLAGS)
AC_SUBST(LFLAGS)

AC_LANG_CPLUSPLUS

ACX_MPI(AC_DEFINE(USE_MPI,1,[Define to build MPI routines]), usempi="no")

AC_CHECK_LIB(png, png_check_sig, LIBS="-lpng -lz -lm $LIBS"; AC_DEFINE(HAVE_PNG,1,[Define if you have PNG library.]), , [-lz -lm])
AC_CHECK_LIB(jpeg, jpeg_read_header, LIBS="-ljpeg $LIBS"; AC_DEFINE(HAVE_JPEG,1,[Define if you have JPEG library.]))
AC_CHECK_LIB(tiff, TIFFError, LIBS="-ltiff -lm $LIBS";AC_DEFINE(HAVE_TIFF,1,[Define if you have TIFF library.]),  , [-lm])

if test "$forceminiblas" = "yes" ; then
  BLAS_LIBS="-L\${top_builddir}/libs/libMiniBLAS -lMiniBLAS"
  miniblasdir="libMiniBLAS"
fi

LAPACK_LIBS="-L\${top_builddir}/libs/libMiniLAPACK -lMiniLAPACK"
minilapackdir="libMiniLAPACK"

if test "$usempi" != "no" ; then
  CXX="$MPICXX"
fi

dnl if test "$usempi" = "yes" ; then
dnl   mpidir="mpi"
dnl fi

AC_SUBST(minilapackdir)
AC_SUBST(miniblasdir)
dnl AC_SUBST(mpidir)
dnl AC_SUBST(MPICXX)
AC_SUBST(maindir)

if test "$forceminiblas" != "yes" ; then
   ACX_BLAS([], forceminiblas=yes)
fi

AM_CONDITIONAL([NEED_BLAS], [test "$forceminiblas" = yes])

AC_OUTPUT(libs/libMiniLAPACK/Makefile)
AC_OUTPUT(libs/libMiniBLAS/Makefile)

LIBS="$LAPACK_LIBS $BLAS_LIBS $LIBS $FLIBS $CURSES_LIB $MPILIBS"

#ac_configure_args="--srcdir=$ac_abs_top_srcdir/libs/libffi $ac_configure_args"
AC_CONFIG_SUBDIRS(libs/libffi)

AC_OUTPUT(Makefile src/Makefile src/x11/Makefile doc/Doxyfile libs/Makefile libs/libFFTPack/Makefile libs/libFreeMat/Makefile libs/libCore/Makefile libs/libGraphics/Makefile libs/libXP/Makefile help/Makefile help/mdc/Makefile help/html/Makefile MFiles/Makefile src/win32/Makefile libs/libf2c/Makefile libs/libjpeg6b/Makefile libs/libtiff361/Makefile libs/libz/Makefile libs/lpng125/Makefile)

echo \
"------------------------------------------------------------------------
Configuration:

  Source code location:       ${srcdir}
  Main location:              ${maindir}
  C Compiler:	              ${CC}
  C Compiler flags:           ${CFLAGS}
  C++ Compiler:		      ${CXX}
  C++ Compiler flags:         ${CXXFLAGS}
  Host System Type:           ${host}
  Install path:		      ${prefix}
  Libs:			      ${LIBS}
  Force Mini-BLAS:	      ${forceminiblas}

------------------------------------------------------------------------"

