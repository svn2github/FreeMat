#!/bin/sh
# A tool to build a relocatable package file.  This is the distribution method
# of choice, and FreeMat currently assumes it is inside a structured package.
# The format for the package is:
#   BaseDir
#     |
#     Contents
#         |
#         Resources
#            |
#            help
#              |
#              html
#              text
#              pdf
#            |
#            mfiles
# On different platforms, additional subdirectories (e.g., bin on Linux/Win32, 
# MacOS on OS X, Frameworks on MacOS X, lib on Linux, etc..) are present.

MakeDir()
{
  echo "Making directory $1"
  test -d $1 || mkdir -p $1
}

CopyFile()
{
  echo "Copying file $1 to $2"
  cp $1 $2
}

CopyDirectory()
{
  echo "Copying directory $1 to $2"
  test -d $2 && rm -rf $2
  cp -R $1 $2
}


ImportLibs()
{
    libset=`LD_LIBRARY_PATH=$QTDIR/lib:$LD_LIBRARY_PATH  ldd $1 | awk '{print $3}'`
    for lib in $libset
      do
      isXlib=`expr match $lib ".*libc\|.*libm\|.*libdl\|.*libpthread\|.*libX\|.*libSM\|.*libICE\|.*libGL\|.*linux"`
      if [ $isXlib == 0 ]
	  then
	  if [ -f $lib ]
	      then
	      CopyFile $lib $2
	  fi
      else
	  echo "Ignored $lib"
      fi
    done
}

MakeLinuxBundle()
{
    baseDir="$buildDir/FreeMat-@VERSION@-Binary"
    rm -rf "$baseDir"
    MakeDir "$baseDir"
    MakeDir "$baseDir/Contents"
    MakeDir "$baseDir/Contents/bin"
    MakeDir "$baseDir/Contents/Resources"
    MakeDir "$baseDir/Contents/Resources/help"
    MakeDir "$baseDir/Contents/Resources/help/html"
    MakeDir "$baseDir/Contents/Resources/help/text"
    MakeDir "$baseDir/Contents/Resources/help/pdf"
    MakeDir "$baseDir/Contents/Resources/toolbox"
    MakeDir "$baseDir/Contents/Plugins/imageformats"
    CopyFile "$buildDir/src/FreeMat" "$baseDir/Contents/bin/FreeMatMain"
    MakeDir "$baseDir/Contents/lib"
    ImportLibs "$baseDir/Contents/bin/FreeMatMain" "$baseDir/Contents/lib"
    echo    "Making run script"
    cat > "$baseDir/Contents/bin/FreeMat" <<EOF
#!/bin/bash
mypath=\`which \$0\`
mypath=\${mypath%/*}
declare -x LD_LIBRARY_PATH=\$mypath/../lib
\$mypath/FreeMatMain \$*
EOF
    chmod +x "$baseDir/Contents/bin/FreeMat"
    CopyDirectory "$srcDir/help/html" "$baseDir/Contents/Resources/help/html"
    CopyDirectory "$srcDir/help/text" "$baseDir/Contents/Resources/help/text"
    CopyDirectory "$srcDir/help/toolbox" "$baseDir/Contents/Resources/toolbox"
    CopyFile "$srcDir/help/latex/main.pdf" "$baseDir/Contents/Resources/help/pdf/FreeMat-@VERSION@.pdf"
    CopyFile "$QTDIR/plugins/imageformats/libqjpeg.so" "$baseDir/Contents/Plugins/imageformats/libqjpeg.so"
    CopyFile "$QTDIR/plugins/imageformats/libqmng.so" "$baseDir/Contents/Plugins/imageformats/libqmng.so"
    ImportLibs "$baseDir/Contents/Plugins/imageformats/libqjpeg.so" "$baseDir/Contents/lib"
    ImportLibs "$baseDir/Contents/Plugins/imageformats/libqmng.so" "$baseDir/Contents/lib"
    echo "Making tar file"
    rm -rf FreeMat-@VERSION@-Binary-Linux.tar.gz
    tar cfz FreeMat-@VERSION@-Binary-Linux.tar.gz FreeMat-@VERSION@-Binary
}

Relink()
{
    echo "Relinking $1 --> $2"
    install_name_tool -change "$QTDIR/lib/$1.framework/Versions/4.0/$1" "@executable_path/../Frameworks/$1.framework/Versions/4.0/$1" "$2"
}

InstallFramework()
{
    echo "Installing framework $1"
    cp -R "$QTDIR/lib/$1.framework" "$baseDir/Contents/Frameworks/$1.framework"
    install_name_tool -id "@executable_path../Frameworks/$1.framework/Versions/4.0/$1" "$baseDir/Contents/Frameworks/$1.framework/Versions/4.0/$1"
    Relink $1 "$baseDir/Contents/MacOS/FreeMat"
}

CrossLinkFramework()
{
    echo "Cross Linking $2 -> $1"
    Relink "$2" "$baseDir/Contents/Frameworks/$1.framework/Versions/4.0/$1"
}

RelinkPlugin() {
    echo "Relinking plugin $1 to framework $2"
    Relink $2 "$baseDir/Contents/Plugins/imageformats/$1"
}

RelinkPlugins() {
    list=`ls $baseDir/Contents/Plugins/imageformats`
    for plugin in $list
    do
	RelinkPlugin $plugin "QtGui"
	RelinkPlugin $plugin "QtCore"
	RelinkPlugin $plugin "QtOpenGL"
    done
}

#basically works - need to prune debug libs, get app icon working, move bundle creation to this script.

MakeMacBundle()
{
    baseDir="$buildDir/FreeMat-@VERSION@.app"
    MakeDir "$baseDir"
    MakeDir "$baseDir/Contents"
    MakeDir "$baseDir/Contents/MacOS"
    MakeDir "$baseDir/Contents/Resources"
    MakeDir "$baseDir/Contents/Resources/help"
    MakeDir "$baseDir/Contents/Resources/help/html"
    MakeDir "$baseDir/Contents/Resources/help/text"
    MakeDir "$baseDir/Contents/Resources/help/pdf"
    MakeDir "$baseDir/Contents/Resources/toolbox"
    MakeDir "$baseDir/Contents/Frameworks"
    CopyFile "$buildDir/src/FreeMat" "$baseDir/Contents/MacOS/FreeMat"
    ln -s "$baseDir/Contents/MacOS/FreeMat" "$baseDir/FreeMat"
    CopyFile "$srcDir/src/appIcon.icns" "$baseDir/Contents/Resources/appIcon.icns"
    echo "APPL????" > "$baseDir/Contents/PkgInfo"
    cat > "$baseDir/Contents/Info.plist" <<EOF
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE plist SYSTEM "file://localhost/System/Library/DTDs/PropertyList.dtd">
 <plist version="0.9">
 <dict>
 <key>CFBundleIconFile</key>
 <string>appIcon.icns</string>
 <key>CFBundlePackageType</key>
 <string>APPL</string>
 <key>CFBundleExecutable</key>
 <string>FreeMat</string>
 </dict>
 </plist>
EOF
    InstallFramework "QtGui"
    InstallFramework "QtCore"
    InstallFramework "QtOpenGL"
    CrossLinkFramework "QtGui" "QtCore"
    CrossLinkFramework "QtOpenGL" "QtGui"
    CrossLinkFramework "QtOpenGL" "QtCore"
    CopyDirectory "$srcDir/help/html" "$baseDir/Contents/Resources/help/html"
    CopyDirectory "$srcDir/help/text" "$baseDir/Contents/Resources/help/text"
    CopyDirectory "$srcDir/help/toolbox" "$baseDir/Contents/Resources/toolbox"
    CopyFile "$srcDir/help/latex/main.pdf" "$baseDir/Contents/Resources/help/pdf/FreeMat-@VERSION@.pdf"
    MakeDir "$baseDir/Contents/Plugins/imageformats"
    CopyDirectory "$QTDIR/plugins/imageformats"  "$baseDir/Contents/Plugins/imageformats"
    RelinkPlugins
    rm -rf `find $baseDir/Contents/Frameworks -name '*debug*'`
    rm -rf `find $baseDir/Contents/Plugins -name '*debug*'`
    hdiutil create -fs HFS+ -srcfolder $baseDir "$buildDir/FreeMat-@VERSION@.dmg"
}


MakeWinBundle()
{
  baseDir="$buildDir/FreeMat-@VERSION@-Win32"
  MakeDir "$baseDir"
  MakeDir "$baseDir/Contents"
  MakeDir "$baseDir/Contents/bin"
  MakeDir "$baseDir/Contents/Resources"
  MakeDir "$baseDir/Contents/Resources/help"
  MakeDir "$baseDir/Contents/Resources/help/html"
  MakeDir "$baseDir/Contents/Resources/help/text"
  MakeDir "$baseDir/Contents/Resources/help/pdf"
  MakeDir "$baseDir/Contents/Resources/toolbox"
  MakeDir "$baseDir/Contents/Plugins/imageformats"
  CopyFile "$QTDIR/plugins/imageformats/qjpeg1.dll" "$baseDir/Contents/Plugins/imageformats/qjpeg1.dll"
  CopyFile "$QTDIR/plugins/imageformats/qmng1.dll" "$baseDir/Contents/Plugins/imageformats/qmng1.dll"
  CopyFile "$buildDir/src/FreeMat.exe" "$baseDir/Contents/bin/FreeMat.exe"
#  CopyFile "$buildDir/tools/blastune/BlasTuneApp.exe" "$baseDir/Contents/bin/BlasTuneApp.exe"
#  CopyFile "$buildDir/tools/blastune/BlasTune.exe" "$baseDir/Contents/bin/BlasTune.exe"
  CopyFile "$QTDIR/bin/QtCore4.dll" "$baseDir/Contents/bin/QtCore4.dll"
  CopyFile "$QTDIR/bin/QtGui4.dll" "$baseDir/Contents/bin/QtGui4.dll"
  CopyFile "$QTDIR/bin/QtOpenGL4.dll" "$baseDir/Contents/bin/QtOpenGL4.dll"
#  CopyFile(sourcepath+"/extern/Root/lib/blas.dll""$baseDir/Contents/bin/blas.dll");
#  //  CopyFile("../../extern/blas/atlas_prebuilt_win32/atlas_blas_P4SSE2.dll",
#  //	   "$baseDir/Contents/bin/blas.dll");
  CopyFile "/mingw/bin/mingwm10.dll" "$baseDir/Contents/bin/mingwm10.dll"
  CopyDirectory "$srcDir/help/html" "$baseDir/Contents/Resources/help/html"
  CopyDirectory "$srcDir/help/text" "$baseDir/Contents/Resources/help/text"
  CopyDirectory "$srcDir/help/toolbox" "$baseDir/Contents/Resources/toolbox"
  CopyFile "$srcDir/help/latex/main.pdf" "$baseDir/Contents/Resources/help/pdf/FreeMat-@VERSION@.pdf"
  echo "Generating NSI file..."
  cdir=`pwd`
  cd $baseDir
  find -type f -printf "  SetOutPath \"\$INSTDIR/%h\"\n  FILE \"%p\"\n" | sed -e 's@/@\\@g' > /tmp/blist
  find -type f -printf "  Delete \"\$INSTDIR/%p\"\n" | sed -e 's@/@\\@g' > /tmp/elist
  cd $cdir
  sed -e '/<BUNDLE FILES>/r /tmp/blist' -e '/<DELLIST>/r /tmp/elist' -e 's/<VERSION_NUMBER>/@VERSION@/g' -e 's/<BUNDLE FILES>//g' -e 's/<DELLIST>//g' < $srcDir/tools/disttool/freemat_nsi.in > $baseDir/freemat.nsi
  cd $baseDir
  /c/Program\ Files/NSIS/makensis freemat.nsi
}

buildDir=$2
srcDir=$3
QTDIR=$4
if test x"$1" == x"--linux"; then
    MakeLinuxBundle 
fi

if test x"$1" == x"--mac"; then
    MakeMacBundle 
fi

if test x"$1" == x"--win"; then
    MakeWinBundle
fi
